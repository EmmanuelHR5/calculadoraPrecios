<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Descuentos JS</title>
    
    <!-- Configuración iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Calc Desc">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/discount--v1.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- --- CSS (ESTILOS) --- -->
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            user-select: none;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f3f4f6;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Sliders */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 28px;
            width: 28px;
            border-radius: 50%;
            background: #ffffff;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            margin-top: -10px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e5e7eb;
            border-radius: 999px;
        }

        /* Utilidades para JS */
        .hidden { display: none !important; }
        .btn-active { 
            background-color: #2563eb !important; /* blue-600 */
            color: white !important;
            box-shadow: 0 10px 15px -3px rgba(191, 219, 254, 0.5);
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100 h-screen w-screen overflow-hidden flex justify-center">

    <!-- --- HTML (ESTRUCTURA) --- -->
    <div class="w-full h-full max-w-md bg-gray-50 flex flex-col relative shadow-2xl">
        
        <!-- Fake Status Bar -->
        <div class="h-12 w-full bg-gray-50 shrink-0"></div>

        <!-- Header -->
        <div class="px-6 pb-4 bg-gray-50 flex justify-between items-center shrink-0">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">Descuentos</h1>
            <div class="bg-gray-200 p-1 rounded-lg flex text-xs font-semibold">
                <button id="btn-mxn" class="px-4 py-1.5 rounded-md transition-all bg-white shadow-sm text-black">MXN</button>
                <button id="btn-usd" class="px-4 py-1.5 rounded-md transition-all text-gray-500">USD</button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto no-scrollbar pb-10">
            <div class="px-5 space-y-5 pt-2">

                <!-- Price Input -->
                <div class="bg-white p-5 rounded-2xl shadow-sm">
                    <label class="text-gray-500 text-xs font-bold uppercase tracking-wider ml-1 flex items-center justify-between">
                        <span id="label-price-currency">Precio Original (MXN)</span>
                        <span id="usa-mode-badge" class="text-blue-500 flex items-center gap-1 hidden">
                            <!-- Globe Icon -->
                            <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg> 
                            Modo USA
                        </span>
                    </label>
                    <div class="mt-2 flex items-center">
                        <span id="currency-symbol" class="text-4xl font-light text-gray-300 mr-2">$</span>
                        <input id="input-price" type="text" inputmode="decimal" placeholder="0" class="w-full text-5xl font-semibold text-gray-900 placeholder-gray-200 outline-none bg-transparent">
                        <button id="btn-clear" class="p-2 bg-gray-100 rounded-full text-gray-400 hover:bg-gray-200 transition hidden">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 2v6h6"></path><path d="M21 12A9 9 0 0 0 6 5.3L3 8"></path><path d="M21 22v-6h-6"></path><path d="M3 12a9 9 0 0 0 15 6.7l3-2.7"></path></svg>
                        </button>
                    </div>
                </div>

                <!-- Exchange Rate Section (Hidden by default) -->
                <div id="section-exchange" class="bg-blue-50 p-4 rounded-2xl border border-blue-100 hidden transition-all duration-300">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-2 text-blue-700">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 3 4 7l4 4"></path><path d="M4 7h16"></path><path d="m16 21 4-4-4-4"></path><path d="M20 17H4"></path></svg>
                            <span class="text-xs font-bold uppercase tracking-wide">Tipo de Cambio</span>
                        </div>
                        <span id="loading-rate" class="text-xs text-blue-400 animate-pulse hidden">Actualizando...</span>
                    </div>
                    <div class="mt-2 flex items-center bg-white rounded-xl px-3 py-2 border border-blue-100">
                        <span class="text-gray-400 text-sm mr-2">1 USD =</span>
                        <span class="text-gray-900 font-bold">$</span>
                        <input id="input-exchange" type="number" value="20.50" class="w-20 font-bold text-gray-900 outline-none bg-transparent">
                        <span class="text-gray-400 text-sm ml-1">MXN</span>
                    </div>
                </div>

                <!-- Discount Selector -->
                <div>
                    <div class="flex justify-between items-center mb-3 px-1">
                        <label class="text-gray-500 text-xs font-bold uppercase tracking-wider">Descuento Principal</label>
                    </div>
                    
                    <div class="bg-white p-5 rounded-2xl shadow-sm mb-4 pt-12">
                        <div class="relative w-full">
                            <!-- Floating Bubble -->
                            <div id="bubble-discount" class="absolute -top-10 bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all" style="left: 20%; transform: translateX(-50%);">
                                <span id="text-discount-bubble">20%</span>
                                <div class="absolute bottom-[-5px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[6px] border-r-[6px] border-t-[6px] border-l-transparent border-r-transparent border-t-blue-600"></div>
                            </div>

                            <input id="input-discount" type="range" min="0" max="100" step="5" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                        </div>
                    </div>

                    <div id="preset-container" class="grid grid-cols-4 gap-3">
                        <!-- Buttons generated by JS or static -->
                        <button class="btn-preset py-3 rounded-xl text-sm font-bold bg-white text-gray-600 hover:bg-gray-50 transition-all" data-val="10">10%</button>
                        <button class="btn-preset py-3 rounded-xl text-sm font-bold bg-white text-gray-600 hover:bg-gray-50 transition-all" data-val="15">15%</button>
                        <button class="btn-preset py-3 rounded-xl text-sm font-bold bg-blue-600 text-white shadow-lg shadow-blue-200 transform scale-105" data-val="20">20%</button>
                        <button class="btn-preset py-3 rounded-xl text-sm font-bold bg-white text-gray-600 hover:bg-gray-50 transition-all" data-val="25">25%</button>
                        <button class="btn-preset py-3 rounded-xl text-sm font-bold bg-white text-gray-600 hover:bg-gray-50 transition-all" data-val="30">30%</button>
                        <button class="btn-preset py-3 rounded-xl text-sm font-bold bg-white text-gray-600 hover:bg-gray-50 transition-all" data-val="40">40%</button>
                        <button class="btn-preset py-3 rounded-xl text-sm font-bold bg-white text-gray-600 hover:bg-gray-50 transition-all" data-val="50">50%</button>
                        <button class="btn-preset py-3 rounded-xl text-sm font-bold bg-white text-gray-600 hover:bg-gray-50 transition-all" data-val="70">70%</button>
                    </div>
                </div>

                <!-- Extra Discount Toggle -->
                <div class="bg-white rounded-2xl shadow-sm overflow-hidden">
                    <div class="p-4 flex items-center justify-between border-b border-gray-100">
                        <div class="flex items-center space-x-3">
                            <div id="icon-tag-wrapper" class="p-2 rounded-lg bg-gray-100 text-gray-400">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
                            </div>
                            <span class="font-medium text-gray-900">Desc. Adicional</span>
                        </div>
                        
                        <button id="btn-toggle-extra" class="w-12 h-7 rounded-full bg-gray-300 transition-colors duration-300 focus:outline-none relative">
                            <div id="toggle-indicator" class="absolute top-0.5 left-0.5 w-6 h-6 bg-white rounded-full shadow-sm transition-transform duration-300"></div>
                        </button>
                    </div>

                    <div id="section-extra" class="px-5 pb-6 pt-12 bg-gray-50 hidden">
                        <div class="relative w-full">
                            <div id="bubble-extra" class="absolute -top-10 bg-green-500 text-white text-sm font-bold py-1 px-3 rounded-lg shadow-md transition-all" style="left: 33%; transform: translateX(-50%);">
                                <span id="text-extra-bubble">10%</span>
                                <div class="absolute bottom-[-5px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[6px] border-r-[6px] border-t-[6px] border-l-transparent border-r-transparent border-t-green-500"></div>
                            </div>

                            <input id="input-extra" type="range" min="0" max="30" step="5" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-green-500">
                        </div>
                        <div class="flex justify-between mt-2 text-xs text-gray-400 font-medium px-1">
                            <span>0%</span>
                            <span>30%</span>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div class="bg-white rounded-3xl shadow-xl p-6 relative overflow-hidden mb-8">
                    <div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-blue-400 via-purple-500 to-pink-500"></div>
                    
                    <div class="space-y-4 pt-2">
                        <div class="flex justify-between text-gray-500 text-sm font-medium">
                            <span>Precio Original</span>
                            <span id="result-original" class="line-through">$0.00</span>
                        </div>
                        
                        <div class="flex justify-between text-green-600 font-bold text-base">
                            <div class="flex items-center">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-1.5"><line x1="19" y1="5" x2="5" y2="19"></line><circle cx="6.5" cy="6.5" r="2.5"></circle><circle cx="17.5" cy="17.5" r="2.5"></circle></svg>
                                <span>Ahorro Total</span>
                            </div>
                            <span id="result-savings">- $0.00</span>
                        </div>

                        <div class="border-t border-gray-100 my-2 pt-4">
                            <div class="flex justify-between items-end">
                                <span class="text-gray-900 font-bold text-lg mb-1">Total a Pagar</span>
                                <span id="result-final" class="text-4xl font-extrabold text-gray-900 tracking-tight">$0.00</span>
                            </div>
                            <div id="result-converted-wrapper" class="hidden mt-4 bg-gray-50 rounded-xl p-3 flex justify-between items-center border border-gray-100">
                                <span class="text-xs font-bold text-gray-500 uppercase">En Pesos (MXN)</span>
                                <span id="result-converted" class="text-2xl font-bold text-blue-600">$0.00</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="h-10"></div>
            </div>
        </div>
    </div>

    <!-- --- JAVASCRIPT (LÓGICA) --- -->
    <script>
        // --- 1. Estado de la App (Variables) ---
        const state = {
            price: '',
            discount: 20,
            hasExtra: false,
            extraDiscount: 10,
            currency: 'MXN', // 'MXN' | 'USD'
            exchangeRate: 20.50
        };

        // --- 2. Elementos del DOM ---
        const els = {
            inputPrice: document.getElementById('input-price'),
            inputDiscount: document.getElementById('input-discount'),
            inputExtra: document.getElementById('input-extra'),
            inputExchange: document.getElementById('input-exchange'),
            
            btnMxn: document.getElementById('btn-mxn'),
            btnUsd: document.getElementById('btn-usd'),
            btnClear: document.getElementById('btn-clear'),
            btnToggleExtra: document.getElementById('btn-toggle-extra'),
            presetButtons: document.querySelectorAll('.btn-preset'),
            
            sectionExchange: document.getElementById('section-exchange'),
            sectionExtra: document.getElementById('section-extra'),
            
            toggleIndicator: document.getElementById('toggle-indicator'),
            iconTagWrapper: document.getElementById('icon-tag-wrapper'),
            
            bubbleDiscount: document.getElementById('bubble-discount'),
            textDiscountBubble: document.getElementById('text-discount-bubble'),
            bubbleExtra: document.getElementById('bubble-extra'),
            textExtraBubble: document.getElementById('text-extra-bubble'),
            
            // Labels y textos estáticos
            labelPriceCurrency: document.getElementById('label-price-currency'),
            usaModeBadge: document.getElementById('usa-mode-badge'),
            currencySymbol: document.getElementById('currency-symbol'),
            
            // Resultados
            resOriginal: document.getElementById('result-original'),
            resSavings: document.getElementById('result-savings'),
            resFinal: document.getElementById('result-final'),
            resConvertedWrapper: document.getElementById('result-converted-wrapper'),
            resConverted: document.getElementById('result-converted'),
            loadingRate: document.getElementById('loading-rate')
        };

        // --- 3. Funciones Principales ---

        function calculate() {
            const originalPrice = parseFloat(state.price);
            
            // Resetear resultados si no hay precio válido
            if (isNaN(originalPrice) || originalPrice <= 0) {
                const zero = formatCurrency(0, state.currency);
                els.resOriginal.innerText = zero;
                els.resSavings.innerText = "- " + zero;
                els.resFinal.innerText = zero;
                els.resConvertedWrapper.classList.add('hidden');
                return;
            }

            // Lógica de cálculo
            const firstDiscountAmount = originalPrice * (state.discount / 100);
            let currentPrice = originalPrice - firstDiscountAmount;
            let totalSavings = firstDiscountAmount;

            if (state.hasExtra) {
                const extraAmount = currentPrice * (state.extraDiscount / 100);
                totalSavings += extraAmount;
                currentPrice -= extraAmount;
            }

            // Conversión
            const finalConverted = state.currency === 'USD' ? currentPrice * state.exchangeRate : 0;

            // Renderizar Textos
            els.resOriginal.innerText = formatCurrency(originalPrice, state.currency);
            els.resSavings.innerText = "- " + formatCurrency(totalSavings, state.currency);
            els.resFinal.innerText = formatCurrency(currentPrice, state.currency);

            // Mostrar resultado convertido si es USD
            if (state.currency === 'USD' && currentPrice > 0) {
                els.resConverted.innerText = formatCurrency(finalConverted, 'MXN');
                els.resConvertedWrapper.classList.remove('hidden');
            } else {
                els.resConvertedWrapper.classList.add('hidden');
            }
        }

        function updateUI() {
            // Moneda
            if (state.currency === 'MXN') {
                els.btnMxn.className = "px-4 py-1.5 rounded-md transition-all bg-white shadow-sm text-black";
                els.btnUsd.className = "px-4 py-1.5 rounded-md transition-all text-gray-500";
                els.sectionExchange.classList.add('hidden');
                els.labelPriceCurrency.innerText = "Precio Original (MXN)";
                els.usaModeBadge.classList.add('hidden');
                els.currencySymbol.innerText = "$";
            } else {
                els.btnMxn.className = "px-4 py-1.5 rounded-md transition-all text-gray-500";
                els.btnUsd.className = "px-4 py-1.5 rounded-md transition-all bg-white shadow-sm text-black";
                els.sectionExchange.classList.remove('hidden');
                els.labelPriceCurrency.innerText = "Precio Original (USD)";
                els.usaModeBadge.classList.remove('hidden');
                els.currencySymbol.innerText = "US$";
            }

            // Toggle Extra
            if (state.hasExtra) {
                els.btnToggleExtra.classList.remove('bg-gray-300');
                els.btnToggleExtra.classList.add('bg-green-500');
                els.toggleIndicator.classList.add('translate-x-5');
                els.sectionExtra.classList.remove('hidden');
                els.iconTagWrapper.classList.remove('bg-gray-100', 'text-gray-400');
                els.iconTagWrapper.classList.add('bg-orange-100', 'text-orange-600');
            } else {
                els.btnToggleExtra.classList.add('bg-gray-300');
                els.btnToggleExtra.classList.remove('bg-green-500');
                els.toggleIndicator.classList.remove('translate-x-5');
                els.sectionExtra.classList.add('hidden');
                els.iconTagWrapper.classList.add('bg-gray-100', 'text-gray-400');
                els.iconTagWrapper.classList.remove('bg-orange-100', 'text-orange-600');
            }

            // Sliders y Burbujas
            updateBubble(els.inputDiscount, els.bubbleDiscount, els.textDiscountBubble, state.discount);
            updateBubble(els.inputExtra, els.bubbleExtra, els.textExtraBubble, state.extraDiscount);

            // Botones de Preset
            els.presetButtons.forEach(btn => {
                const val = parseInt(btn.getAttribute('data-val'));
                if (val === state.discount) {
                    btn.classList.add('btn-active');
                    btn.classList.remove('bg-white', 'text-gray-600');
                } else {
                    btn.classList.remove('btn-active');
                    btn.classList.add('bg-white', 'text-gray-600');
                }
            });

            // Botón Limpiar
            if (state.price) {
                els.btnClear.classList.remove('hidden');
            } else {
                els.btnClear.classList.add('hidden');
            }

            // Recalcular
            calculate();
        }

        // --- 4. Utilerías ---
        function formatCurrency(val, currency) {
            return new Intl.NumberFormat('es-MX', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2
            }).format(val);
        }

        function updateBubble(input, bubble, textEl, value) {
            input.value = value;
            textEl.innerText = value + '%';
            // Calcular posición %
            const min = input.min ? input.min : 0;
            const max = input.max ? input.max : 100;
            const newVal = Number(((value - min) * 100) / (max - min));
            bubble.style.left = `calc(${newVal}% + (${8 - newVal * 0.15}px))`;
        }

        async function fetchExchangeRate() {
            els.loadingRate.classList.remove('hidden');
            try {
                const response = await fetch('https://open.er-api.com/v6/latest/USD');
                const data = await response.json();
                if (data && data.rates && data.rates.MXN) {
                    state.exchangeRate = parseFloat(data.rates.MXN.toFixed(2));
                    els.inputExchange.value = state.exchangeRate;
                }
            } catch (error) {
                console.log("Error fetching rate");
            } finally {
                els.loadingRate.classList.add('hidden');
                calculate();
            }
        }

        // --- 5. Event Listeners ---

        els.inputPrice.addEventListener('input', (e) => {
            const val = e.target.value;
            // Validar solo números y punto decimal
            if (val === '' || /^\d*\.?\d*$/.test(val)) {
                state.price = val;
                updateUI();
            } else {
                e.target.value = state.price;
            }
        });

        els.btnClear.addEventListener('click', () => {
            state.price = '';
            els.inputPrice.value = '';
            els.inputPrice.focus();
            updateUI();
        });

        els.btnMxn.addEventListener('click', () => {
            state.currency = 'MXN';
            updateUI();
        });

        els.btnUsd.addEventListener('click', () => {
            state.currency = 'USD';
            updateUI();
            fetchExchangeRate();
        });

        els.inputDiscount.addEventListener('input', (e) => {
            state.discount = parseInt(e.target.value);
            updateUI();
        });

        els.inputExtra.addEventListener('input', (e) => {
            state.extraDiscount = parseInt(e.target.value);
            updateUI();
        });

        els.btnToggleExtra.addEventListener('click', () => {
            state.hasExtra = !state.hasExtra;
            updateUI();
        });

        els.presetButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                state.discount = parseInt(btn.getAttribute('data-val'));
                updateUI();
            });
        });

        els.inputExchange.addEventListener('input', (e) => {
            state.exchangeRate = parseFloat(e.target.value) || 0;
            calculate();
        });

        // --- Init ---
        updateUI();

    </script>
</body>
</html>